<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statikos užimtumo ataskaitos | LT ADVERT</title>
    <!-- Bibliotekos iš CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- PDF generavimo biblioteka -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sticky-col { position: sticky; left: 0; z-index: 10; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #818cf8; }
        .row-expand-transition { transition: all 0.3s ease-in-out; }
        
        /* PDF EXPORT STYLES */
        .is-exporting {
            width: 2400px !important;
            background: white !important;
        }
        .is-exporting .no-print,
        .is-exporting .no-print-row { display: none !important; }
        .is-exporting .sticky, 
        .is-exporting .sticky-col { position: static !important; }
        .is-exporting table { width: 100% !important; table-layout: auto !important; border: 1px solid #000 !important; }
        .is-exporting th, .is-exporting td { border: 1px solid #ddd !important; padding: 4px !important; }
        .is-exporting .overflow-x-auto, 
        .is-exporting .max-h-[75vh] { overflow: visible !important; max-height: none !important; }
        
        .pdf-header { display: none; }
        @media print {
            .pdf-header { display: flex !important; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, Fragment } = React;

        // Įmonės LOGO komponentas
        const Logo = ({ className = "h-12" }) => (
            <svg viewBox="0 0 350 85" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M5 35 H28 V12 H5 Z" stroke="#4cb848" strokeWidth="2.5" fill="none" />
                <path d="M16.5 35 V48" stroke="#4cb848" strokeWidth="2.5" fill="none" />
                <path d="M5 48 H340" stroke="#4cb848" strokeWidth="1.5" />
                <text x="42" y="38" fill="#4cb848" style={{ font: '900 38px Inter, sans-serif' }}>LT ADVERT</text>
                <text x="7" y="68" fill="#222" style={{ font: '700 13px Inter, sans-serif', letterSpacing: '4.5px' }}>LAUKO REKLAMOS SPRENDIMAI</text>
            </svg>
        );

        const IconFile = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconChevron = ({ expanded }) => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ transition: 'transform 0.2s', transform: expanded ? 'rotate(90deg)' : 'rotate(0deg)' }}><polyline points="9 18 15 12 9 6"/></svg>;

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [fileName, setFileName] = useState("");
            const [errorInfo, setErrorInfo] = useState("");
            const [activeTab, setActiveTab] = useState("ataskaita");
            const [showColPicker, setShowColPicker] = useState(false);
            
            const [startMonth, setStartMonth] = useState("2026-01");
            const [endMonth, setEndMonth] = useState("2026-03");
            const [saleFilter, setSaleFilter] = useState("mokamas");
            const [ordersMonth, setOrdersMonth] = useState("2026-01");

            const [expandedOrders, setExpandedOrders] = useState(new Set());

            const [vis, setVis] = useState({
                s_pot: true, s_used_pct: true, s_change: true, s_free: true, s_free_pct: true,
                k_pot: false, k_used: false, k_used_pct: false, k_free_pct: false
            });

            const [filterCity, setFilterCity] = useState("");

            const toggleOrderExpansion = (name) => {
                const newExpanded = new Set(expandedOrders);
                if (newExpanded.has(name)) newExpanded.delete(name);
                else newExpanded.add(name);
                setExpandedOrders(newExpanded);
            };

            const handleDownloadPDF = () => {
                const element = document.getElementById('report-content');
                if (!element) return;

                element.classList.add('is-exporting');
                const header = element.querySelector('.pdf-header');
                if (header) header.style.display = 'flex';

                const options = {
                    margin: [8, 8, 8, 8],
                    filename: `LT_ADVERT_Ataskaita_${activeTab}_v17.3.pdf`,
                    image: { type: 'jpeg', quality: 1.0 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false,
                        letterRendering: true,
                        windowWidth: 2400
                    },
                    jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
                };

                html2pdf().set(options).from(element).save().then(() => {
                    if (header) header.style.display = '';
                    element.classList.remove('is-exporting');
                });
            };

            const formatDate = (val) => {
                if (!val) return null;
                if (val instanceof Date) return val.toISOString().split('T')[0];
                if (typeof val === 'number') {
                    const date = new Date((val - 25569) * 86400 * 1000);
                    return date.toISOString().split('T')[0];
                }
                const clean = val.toString().trim();
                if (clean.includes('-')) return clean.split(' ')[0];
                if (clean.includes('.')) {
                    const parts = clean.split('.');
                    if (parts[0].length === 4) return `${parts[0]}-${parts[1]}-${parts[2]}`;
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                return clean;
            };

            const findKey = (row, keys) => {
                const rowKeys = Object.keys(row);
                for (const k of keys) {
                    const found = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim() || rk.toLowerCase().includes(k.toLowerCase()));
                    if (found) return found;
                }
                return null;
            };

            const getSaleType = (text) => {
                if (!text) return "laisva";
                const cleanText = text.toString().trim();
                if (/R[1-9](\s+iki\s+\d{2}-\d{2})?\.?$/i.test(cleanText)) return "rezervacija";
                if (/Savininko reklama|nemokamas/i.test(cleanText)) return "nemokamas";
                if (/{N}|{SOCN}/i.test(cleanText)) return "nemokamas";
                if (/LT advert|savireklama/i.test(cleanText)) return "nemokamas";
                if (/{R}|{S}/i.test(cleanText)) return "mokamas";
                const hasOrderNumber = /\b\d{4}\b/.test(cleanText);
                const initialsMatch = cleanText.match(/[A-Z]\.\s*[A-Z]\./g) || [];
                const hasValidInitials = initialsMatch.some(init => init.replace(/\s/g, '').toUpperCase() !== 'R.P.');
                if (hasOrderNumber && hasValidInitials) return "mokamas";
                return "nemokamas";
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                setLoading(true);
                setErrorInfo("");
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const dataArr = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(dataArr, { type: 'array', cellDates: true });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        if (jsonData.length === 0) {
                            setErrorInfo("Failas tuščias.");
                        } else {
                            const firstRow = jsonData[0];
                            const kKodas = findKey(firstRow, ["Stendo kodas", "Kodas", "ID"]);
                            const kData = findKey(firstRow, ["Data", "Date"]);
                            const kKategorija = findKey(firstRow, ["N - Kategorija", "Kategorija", "Category"]);
                            const kMiestas = findKey(firstRow, ["Miestas", "City"]);
                            const kAdresas = findKey(firstRow, ["Pardavimų adresas", "Adresas", "Address"]);
                            const kPardavimas = findKey(firstRow, ["Pardavimas", "Client", "Klientas"]);
                            const kStatusas = findKey(firstRow, ["Statusas", "Status"]);
                            const kTipas = findKey(firstRow, ["Tipas", "Type"]);

                            const normalized = jsonData.map(row => ({
                                Kodas: row[kKodas] || "",
                                Data: formatDate(row[kData]),
                                Kategorija: row[kKategorija] || "Kita",
                                Pardavimas: row[kPardavimas] || "",
                                Statusas: row[kStatusas] || "",
                                Miestas: row[kMiestas] || "",
                                Adresas: row[kAdresas] || "",
                                Tipas: row[kTipas] || "",
                                SaleType: getSaleType(row[kPardavimas])
                            })).filter(r => r.Kodas);

                            setData(normalized);
                        }
                    } catch (err) { 
                        setErrorInfo("Klaida nuskaitant failą.");
                    }
                    setLoading(false);
                };
                reader.readAsArrayBuffer(file);
            };

            const standInventory = useMemo(() => {
                const inventory = new Map();
                if (!data.length) return inventory;
                data.forEach(row => {
                    const code = row.Kodas;
                    if (!code) return;
                    const rawStatus = (row.Statusas || "").toLowerCase();
                    let calculatedStatus = "Aktyvus";
                    if (rawStatus.includes("x")) calculatedStatus = "Neaktyvus";
                    else if (rawStatus.includes("ruošiama") || rawStatus.includes("remontuojama")) calculatedStatus = "Laikinai neveikia";

                    if (!inventory.has(code)) {
                        inventory.set(code, {
                            kodas: code, miestas: row.Miestas || "Nenurodyta", adresas: row.Adresas || "Nenurodyta",
                            tipas: row.Tipas || "Nenurodyta", kategorija: row.Kategorija || "Kita",
                            status: calculatedStatus, catKey: (row.Kategorija || "Kita").toLowerCase().trim()
                        });
                    } else if (calculatedStatus === "Aktyvus" && inventory.get(code).status !== "Aktyvus") {
                        inventory.get(code).status = "Aktyvus";
                    }
                });
                return inventory;
            }, [data]);

            const filterOptions = useMemo(() => {
                const cities = new Set();
                const categories = new Set();
                standInventory.forEach(s => {
                    if (s.miestas) cities.add(s.miestas);
                    if (s.kategorija) categories.add(s.kategorija);
                });
                return { cities: Array.from(cities).sort(), categories: Array.from(categories).sort() };
            }, [standInventory]);

            const ORDER_MUSU = ["Vilnius", "Kaunas", "Klaipėda", "Šiauliai", "Panevėžys", "Regionai", "Kolonos", "Vitrinos", "Nestandartai"];
            const ORDER_SUBNUOMA = ["Subnuoma", "Vitrinos sub"];

            const report = useMemo(() => {
                if (!data.length || !startMonth || !endMonth) return null;
                const summary = {};
                const start = new Date(startMonth + "-01");
                const end = new Date(endMonth + "-01");
                const sortedMonths = [];
                let currentM = new Date(start);
                while (currentM <= end) {
                    sortedMonths.push(currentM.toISOString().substring(0, 7));
                    currentM.setMonth(currentM.getMonth() + 1);
                }
                const baseMonthDate = new Date(startMonth + "-01");
                baseMonthDate.setMonth(baseMonthDate.getMonth() - 1);
                const baseMonthStr = baseMonthDate.toISOString().substring(0, 7);
                const allNeededMonths = [baseMonthStr, ...sortedMonths];

                const allCats = [...ORDER_MUSU, ...ORDER_SUBNUOMA];
                allCats.forEach(c => {
                    const catKey = c.toLowerCase();
                    const potCount = Array.from(standInventory.values())
                        .filter(s => s.catKey === catKey && s.status !== "Neaktyvus").length;
                    summary[catKey] = { name: c, potentialUnits: potCount, monthlyStats: {} };
                    allNeededMonths.forEach(m => {
                        const [y, mon] = m.split('-').map(Number);
                        const daysInMonth = new Date(y, mon, 0).getDate();
                        summary[catKey].monthlyStats[m] = { uniqueSoldStands: new Set(), soldDaysCount: 0, potentialDays: potCount * daysInMonth };
                    });
                });

                data.forEach(row => {
                    const rowDate = row.Data;
                    if (!rowDate || rowDate.length < 7) return;
                    const m = rowDate.substring(0, 7);
                    const catKey = row.Kategorija.toLowerCase().trim();
                    const stats = summary[catKey]?.monthlyStats[m];
                    if (!stats) return;
                    const client = row.Pardavimas;
                    if (!client || client.toString().trim().length === 0) return;
                    let matchesFilter = false;
                    if (saleFilter === "mokamas") matchesFilter = row.SaleType === "mokamas";
                    else if (saleFilter === "nemokamas") matchesFilter = row.SaleType === "nemokamas";
                    else if (saleFilter === "rezervacija") matchesFilter = row.SaleType === "rezervacija";
                    else if (saleFilter === "bendrai") matchesFilter = (row.SaleType === "mokamas" || row.SaleType === "nemokamas");

                    if (matchesFilter) {
                        stats.uniqueSoldStands.add(row.Kodas);
                        stats.soldDaysCount += 1;
                    }
                });

                const calculateTotal = (list, name) => {
                    const total = { name, potentialUnits: 0, monthlyStats: {} };
                    list.forEach(cName => {
                        const s = summary[cName.toLowerCase()];
                        if (!s) return;
                        total.potentialUnits += s.potentialUnits;
                        allNeededMonths.forEach(m => {
                            if (!total.monthlyStats[m]) total.monthlyStats[m] = { uniqueSoldStands: new Set(), soldDaysCount: 0, potentialDays: 0 };
                            const ms = s.monthlyStats[m];
                            ms.uniqueSoldStands.forEach(id => total.monthlyStats[m].uniqueSoldStands.add(id));
                            total.monthlyStats[m].soldDaysCount += ms.soldDaysCount;
                            total.monthlyStats[m].potentialDays += ms.potentialDays;
                        });
                    });
                    return total;
                };

                return { months: sortedMonths, baseMonth: baseMonthStr, summary, visoMusu: calculateTotal(ORDER_MUSU, "VISO MŪSŲ"), visoSubnuoma: calculateTotal(ORDER_SUBNUOMA, "VISO SUBNUOMA"), grandTotal: calculateTotal([...ORDER_MUSU, ...ORDER_SUBNUOMA], "ABSOLIUČIAI VISKAS") };
            }, [data, startMonth, endMonth, standInventory, saleFilter]);

            const ordersReport = useMemo(() => {
                if (!data.length) return [];
                const ordersMap = new Map();
                data.forEach(row => {
                    const pName = (row.Pardavimas || "").toString().trim();
                    if (!pName || !row.Data) return;
                    if (!row.Data.startsWith(ordersMonth)) return;

                    let matches = false;
                    if (saleFilter === "bendrai") matches = (row.SaleType === "mokamas" || row.SaleType === "nemokamas");
                    else matches = (row.SaleType === saleFilter);

                    if (!matches) return;

                    if (!ordersMap.has(pName)) {
                        ordersMap.set(pName, { 
                            name: pName, 
                            type: row.SaleType, 
                            startDate: row.Data, 
                            endDate: row.Data,
                            stands: new Map() 
                        });
                    }
                    const entry = ordersMap.get(pName);
                    if (row.Data < entry.startDate) entry.startDate = row.Data;
                    if (row.Data > entry.endDate) entry.endDate = row.Data;
                    
                    if (!entry.stands.has(row.Kodas)) {
                        entry.stands.set(row.Kodas, {
                            kodas: row.Kodas,
                            miestas: row.Miestas || "Nenurodyta",
                            adresas: row.Adresas || "Nenurodyta"
                        });
                    }
                });
                return Array.from(ordersMap.values())
                    .map(o => ({
                        ...o,
                        standsCount: o.stands.size,
                        standsList: Array.from(o.stands.values()).sort((a, b) => a.miestas.localeCompare(b.miestas))
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name));
            }, [data, saleFilter, ordersMonth]);

            const monthColSpan = useMemo(() => {
                const s_count = [vis.s_pot, vis.s_used_pct, vis.s_change, vis.s_free, vis.s_free_pct].filter(Boolean).length;
                const k_count = [vis.k_pot, vis.k_used, vis.k_used_pct, vis.k_free_pct].filter(Boolean).length;
                return { s_count, k_count, total: s_count + k_count };
            }, [vis]);

            const monthNames = { "01": "Sausis", "02": "Vasaris", "03": "Kovas", "04": "Balandis", "05": "Gegužė", "06": "Birželis", "07": "Liepa", "08": "Rugpjūtis", "09": "Rugsėjis", "10": "Spalis", "11": "Lapkritis", "12": "Gruodis" };
            const shortMonthNames = { "01": "sau", "02": "vas", "03": "kov", "04": "bal", "05": "geg", "06": "bir", "07": "lie", "08": "rugp", "09": "rugs", "10": "spa", "11": "lap", "12": "gruo" };

            const toggleCol = (key) => setVis(prev => ({ ...prev, [key]: !prev[key] }));
            const toggleGroup = (group) => {
                const keys = group === 'stendai' ? ['s_pot', 's_used_pct', 's_change', 's_free', 's_free_pct'] : ['k_pot', 'k_used', 'k_used_pct', 'k_free_pct'];
                const newState = !vis[keys[0]];
                setVis(prev => {
                    const upd = {...prev};
                    keys.forEach(k => upd[k] = newState);
                    return upd;
                });
            };

            const renderRow = (s, type = "normal") => {
                if (!s) return null;
                const potUnits = s.potentialUnits || 0;
                let rowBg = "bg-white", stickyBg = "bg-white", textColor = "text-black";
                if (type === "musu") { rowBg = "bg-emerald-50"; stickyBg = "bg-emerald-100"; textColor = "text-emerald-900 font-black"; }
                else if (type === "sub") { rowBg = "bg-blue-50"; stickyBg = "bg-blue-100"; textColor = "text-blue-900 font-black"; }
                else if (type === "grand") { rowBg = "bg-orange-100"; stickyBg = "bg-orange-200"; textColor = "text-orange-900 font-black"; }

                return (
                    <tr key={s.name} className={`border-b border-gray-100 hover:opacity-90 transition-opacity ${rowBg} ${type !== 'normal' ? 'font-black' : ''}`}>
                        <td className={`p-2 border-r sticky-col sticky left-0 z-10 shadow-sm ${stickyBg} ${textColor} text-[11px]`}>{s.name}</td>
                        {report.months.map((m, mIdx) => {
                            const stats = s.monthlyStats[m];
                            const potDays = stats?.potentialDays || 0;
                            const usedDays = stats?.soldDaysCount || 0;
                            const daysInMonth = potUnits > 0 ? (potDays / potUnits) : 30;
                            const usedUnitsProportional = usedDays / daysInMonth;
                            const freeUnits = Math.max(0, potUnits - usedUnitsProportional);
                            const fillRate = potDays > 0 ? Math.min(100, (usedDays / potDays) * 100) : 0;
                            const freeRate = 100 - fillRate;

                            let changeDisplay = "-", changeCellClass = "";
                            const prevMonthStr = mIdx === 0 ? report.baseMonth : report.months[mIdx - 1];
                            const prevStats = s.monthlyStats[prevMonthStr];
                            if (prevStats) {
                                const prevPotDays = prevStats.potentialDays || 0;
                                const prevUsedDays = prevStats.soldDaysCount || 0;
                                const prevDaysInMonth = potUnits > 0 ? (prevPotDays / potUnits) : 30;
                                const prevUsedUnitsProportional = prevUsedDays / prevDaysInMonth;
                                const prevFreeUnits = Math.max(0, potUnits - prevUsedUnitsProportional);
                                const diff = freeUnits - prevFreeUnits;
                                if (prevPotDays > 0) {
                                    const formattedDiff = diff.toFixed(1);
                                    if (Math.abs(diff) < 0.05) {
                                        changeDisplay = "0.0";
                                        changeCellClass = "text-black opacity-50";
                                    } else {
                                        changeDisplay = diff > 0 ? `+${formattedDiff}` : `${formattedDiff}`;
                                        if (diff > 0) changeCellClass = "bg-red-500 text-white font-black";
                                        else changeCellClass = "bg-emerald-500 text-white font-black";
                                    }
                                }
                            }
                            const colColor = mIdx % 2 === 0 ? 'bg-black/5' : '';
                            return (
                                <Fragment key={m}>
                                    {vis.s_pot && <td className={`p-1.5 border-r text-center font-black text-black ${colColor} text-[11px]`}>{potUnits}</td>}
                                    {vis.s_used_pct && <td className={`p-1.5 border-r text-center font-black ${fillRate > 0 ? 'text-emerald-600' : 'text-black opacity-40'} ${colColor} text-[11px]`}>{fillRate.toFixed(1)}%</td>}
                                    {vis.s_change && <td className={`p-1.5 border-r text-center ${changeCellClass} ${changeCellClass === "" ? colColor : ""} text-[11px]`}>{changeDisplay}</td>}
                                    {vis.s_free && <td className={`p-1.5 border-r text-center font-bold text-red-600 ${colColor} text-[11px]`}>{freeUnits.toFixed(1)}</td>}
                                    {vis.s_free_pct && <td className={`p-1.5 border-r text-center font-bold ${fillRate < 100 ? 'text-red-600' : 'text-black opacity-40'} ${colColor} text-[11px]`}>{freeRate.toFixed(1)}%</td>}
                                    {vis.k_pot && <td className={`p-1.5 border-r text-center font-black text-black ${colColor} text-[11px]`}>{potDays}</td>}
                                    {vis.k_used && <td className={`p-1.5 border-r text-center font-black ${usedDays > 0 ? 'text-emerald-600' : 'text-black opacity-40'} ${colColor} text-[11px]`}>{usedDays}</td>}
                                    {vis.k_used_pct && <td className={`p-1.5 border-r text-center font-black ${fillRate > 0 ? 'text-emerald-600' : 'text-black opacity-40'} ${colColor} text-[11px]`}>{fillRate.toFixed(1)}%</td>}
                                    {vis.k_free_pct && <td className={`p-1.5 border-r text-center font-bold ${fillRate < 100 ? 'text-red-600' : 'text-black opacity-40'} ${colColor} text-[11px]`}>{freeRate.toFixed(1)}%</td>}
                                </Fragment>
                            );
                        })}
                    </tr>
                );
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-6 lg:p-8">
                    <div className="max-w-full mx-auto">
                        <div className="bg-white p-4 lg:p-6 rounded-2xl shadow-sm border border-gray-200 mb-6 no-print">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-3">
                                    <Logo className="h-10 lg:h-12" />
                                    <div className="border-l pl-4 border-gray-200">
                                        <h1 className="text-lg lg:text-xl font-black text-indigo-900 tracking-tight leading-none mb-1 uppercase">Statika <span className="font-normal text-indigo-400 text-sm tracking-normal capitalize">PRO v17.3</span></h1>
                                        <p className="text-gray-400 text-[10px] uppercase font-bold tracking-widest text-left">Užimtumo Analizė</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 lg:gap-3">
                                    <button 
                                        onClick={handleDownloadPDF}
                                        className="flex items-center gap-2 px-4 lg:px-6 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-xl text-xs lg:text-sm font-bold transition-all border border-indigo-100 shadow-sm"
                                    >
                                        <IconDownload /> Atsisiųsti PDF
                                    </button>
                                    <label className="flex items-center gap-2 px-4 lg:px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs lg:text-sm font-bold cursor-pointer transition-all shadow-lg shadow-indigo-100">
                                        <IconUpload /> Įkelti failą
                                        <input type="file" className="hidden" onChange={handleFileUpload} accept=".xlsx,.xls,.csv" />
                                    </label>
                                </div>
                            </div>
                            {data.length > 0 && (
                                <div className="flex border-b border-gray-100 mt-6 overflow-x-auto whitespace-nowrap">
                                    <button onClick={() => setActiveTab("ataskaita")} className={`px-4 lg:px-6 py-3 text-xs lg:text-sm font-bold transition-all border-b-2 ${activeTab === "ataskaita" ? "border-indigo-600 text-indigo-600" : "border-transparent text-gray-400 hover:text-gray-600"}`}>Mėnesių ataskaita</button>
                                    <button onClick={() => setActiveTab("uzsakymai")} className={`px-4 lg:px-6 py-3 text-xs lg:text-sm font-bold transition-all border-b-2 ${activeTab === "uzsakymai" ? "border-indigo-600 text-indigo-600" : "border-transparent text-gray-400 hover:text-gray-600"}`}>Užsakymų lapas</button>
                                    <button onClick={() => setActiveTab("registras")} className={`px-4 lg:px-6 py-3 text-xs lg:text-sm font-bold transition-all border-b-2 ${activeTab === "registras" ? "border-indigo-600 text-indigo-600" : "border-transparent text-gray-400 hover:text-gray-600"}`}>Stendų registras</button>
                                </div>
                            )}
                        </div>

                        {data.length > 0 ? (
                            <div id="report-content" className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden animate-in fade-in pdf-content">
                                {/* PDF HEADERIS */}
                                <div className="pdf-header hidden flex-col border-b-4 border-emerald-500 p-8 mb-4 bg-white">
                                    <div className="flex justify-between items-start w-full">
                                        <Logo className="h-16" />
                                        <div className="text-right">
                                            <h2 className="text-2xl font-black text-gray-900 uppercase tracking-tight">Statikos Užimtumo Suvestinė v17.3</h2>
                                            <p className="text-gray-500 font-bold uppercase text-xs tracking-widest mt-1">Generuota: {new Date().toLocaleDateString('lt-LT')}</p>
                                        </div>
                                    </div>
                                    <div className="mt-8 flex gap-8 text-xs font-bold uppercase text-black">
                                        <div><span className="opacity-60">Ataskaita:</span> {activeTab === "ataskaita" ? "Mėnesių suvestinė" : "Užsakymų lapas"}</div>
                                        <div><span className="opacity-60">Tipas:</span> {saleFilter.toUpperCase()}</div>
                                        {activeTab === "ataskaita" ? (
                                            <div><span className="opacity-60">Laikotarpis:</span> {startMonth} iki {endMonth}</div>
                                        ) : (
                                            <div><span className="opacity-60">Mėnuo:</span> {ordersMonth}</div>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white p-3 lg:p-4 border-b flex flex-wrap items-center gap-4 lg:gap-6 no-print">
                                    {activeTab === "ataskaita" && (
                                        <>
                                            <div className="flex flex-col gap-1"><span className="text-[10px] text-black font-black uppercase">Nuo</span><input type="month" value={startMonth} onChange={(e) => setStartMonth(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-2 lg:px-3 py-1.5 text-xs lg:text-sm font-bold text-indigo-700 outline-none" /></div>
                                            <div className="flex flex-col gap-1"><span className="text-[10px] text-black font-black uppercase">Iki</span><input type="month" value={endMonth} onChange={(e) => setEndMonth(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-2 lg:px-3 py-1.5 text-xs lg:text-sm font-bold text-indigo-700 outline-none" /></div>
                                        </>
                                    )}
                                    {activeTab === "uzsakymai" && (
                                        <div className="flex flex-col gap-1">
                                            <span className="text-[10px] text-black font-black uppercase">Pasirinktas mėnuo</span>
                                            <input type="month" value={ordersMonth} onChange={(e) => setOrdersMonth(e.target.value)} className="bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-1.5 text-xs lg:text-sm font-bold text-indigo-700 outline-none" />
                                        </div>
                                    )}
                                    {(activeTab === "ataskaita" || activeTab === "uzsakymai") && (
                                        <div className="flex flex-col gap-1">
                                            <span className="text-[10px] text-black font-black uppercase">Pardavimų tipas</span>
                                            <select value={saleFilter} onChange={(e) => setSaleFilter(e.target.value)} className="bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-1.5 text-xs lg:text-sm font-bold text-indigo-700 outline-none">
                                                <option value="mokamas">Tik komerciniai</option>
                                                <option value="nemokamas">Tik nemokami</option>
                                                <option value="bendrai">Bendrai (Mokami + Nemokami)</option>
                                                <option value="rezervacija">Tik rezervacijos</option>
                                            </select>
                                        </div>
                                    )}
                                    {activeTab === "ataskaita" && (
                                        <div className="relative mt-5">
                                            <button onClick={() => setShowColPicker(!showColPicker)} className={`flex items-center gap-2 px-3 lg:px-4 py-2 border rounded-xl text-[10px] lg:text-xs font-bold transition-all ${showColPicker ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white text-gray-600 border-gray-200'}`}><IconSettings /> Stulpeliai</button>
                                            {showColPicker && (
                                                <div className="absolute top-full left-0 mt-2 bg-white border border-gray-100 shadow-2xl rounded-2xl p-5 z-50 min-w-[350px] animate-in slide-in-from-top-2">
                                                    <div className="grid grid-cols-2 gap-8">
                                                        <div className="space-y-2">
                                                            <div className="flex justify-between border-b pb-1"><span className="text-[10px] font-black text-indigo-600 uppercase">Stendai</span><button onClick={() => toggleGroup('stendai')} className="text-[9px] text-indigo-400 font-bold underline">Perjungti</button></div>
                                                            {[{id:'s_pot',l:'Galimybė'},{id:'s_used_pct',l:'Išnaudota %'},{id:'s_change',l:'Pokytis'},{id:'s_free',l:'Laisvi'},{id:'s_free_pct',l:'Laisvi %'}].map(c=>(<label key={c.id} className="flex items-center gap-2 text-xs cursor-pointer hover:text-indigo-600 py-1"><input type="checkbox" checked={vis[c.id]} onChange={()=>toggleCol(c.id)} className="rounded border-gray-300 text-indigo-600" />{c.l}</label>))}
                                                        </div>
                                                        <div className="space-y-2">
                                                            <div className="flex justify-between border-b pb-1"><span className="text-[10px] font-black text-amber-600 uppercase">Kabėjimas</span><button onClick={() => toggleGroup('kabėjimas')} className="text-[9px] text-amber-400 font-bold underline">Perjungti</button></div>
                                                            {[{id:'k_pot',l:'Galimybė'},{id:'k_used',l:'Išnaudota'},{id:'k_used_pct',l:'Išnaudojimo %'},{id:'k_free_pct',l:'Laisvi %'}].map(c=>(<label key={c.id} className="flex items-center gap-2 text-xs cursor-pointer hover:text-amber-600 py-1"><input type="checkbox" checked={vis[c.id]} onChange={()=>toggleCol(c.id)} className="rounded border-gray-300 text-amber-600" />{c.l}</label>))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {activeTab === "ataskaita" && report ? (
                                    <div className="overflow-x-auto max-h-[75vh]">
                                        <table className="w-full text-xs text-left border-collapse table-fixed min-w-[1200px]">
                                            <thead className="sticky top-0 z-20">
                                                <tr className="bg-gray-100 border-b text-black">
                                                    <th rowSpan="3" className="p-3 border-r sticky-col sticky left-0 bg-gray-100 z-30 w-44 font-black shadow-sm text-[11px]">Kategorija</th>
                                                    {report.months.map((m, mIdx) => {
                                                        const isAlt = mIdx % 2 === 0;
                                                        return monthColSpan.total > 0 && (
                                                            <th key={m} colSpan={monthColSpan.total} className={`p-2 border-r text-center font-black text-indigo-900 bg-white border-b-2 border-indigo-100 ${isAlt ? 'bg-gray-200 !text-black' : ''}`}>
                                                                {monthNames[m.split('-')[1]]} ({m.split('-')[0]})
                                                            </th>
                                                        );
                                                    })}
                                                </tr>
                                                <tr className="bg-gray-50 border-b text-[10px] font-black text-center uppercase tracking-widest">
                                                    {report.months.map((m, mIdx) => (
                                                        <Fragment key={`${m}-g`}>
                                                            {monthColSpan.s_count > 0 && <th colSpan={monthColSpan.s_count} className={`p-1.5 border-r text-indigo-600 ${mIdx % 2 === 0 ? 'bg-gray-200/50' : 'bg-gray-50'}`}>Stendai</th>}
                                                            {monthColSpan.k_count > 0 && <th colSpan={monthColSpan.k_count} className={`p-1.5 border-r text-amber-600 ${mIdx % 2 === 0 ? 'bg-gray-200/50' : 'bg-gray-50'}`}>Kabėjimas</th>}
                                                        </Fragment>
                                                    ))}
                                                </tr>
                                                <tr className="bg-white border-b text-[9px] font-black uppercase text-black text-center">
                                                    {report.months.map((m, mIdx) => (
                                                        <Fragment key={`${m}-d`}>
                                                            {vis.s_pot && <th className={`p-1 border-r w-12 ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>Pot.</th>}
                                                            {vis.s_used_pct && <th className={`p-1 border-r w-14 text-emerald-600 font-black ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>Išn. %</th>}
                                                            {vis.s_change && (
                                                                <th className={`p-1 border-r w-14 ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>
                                                                    <div className="flex flex-col leading-none">
                                                                        <span>Pokyt.</span>
                                                                        <span className="text-[7px] font-bold opacity-70">
                                                                            nuo {(() => { const prevM = mIdx === 0 ? report.baseMonth : report.months[mIdx - 1]; const [y, mon] = prevM.split('-'); return `${y.slice(-2)}-${shortMonthNames[mon]}`; })()}.
                                                                        </span>
                                                                    </div>
                                                                </th>
                                                            )}
                                                            {vis.s_free && <th className={`p-1 border-r w-12 text-red-600 font-black ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>Laisvi</th>}
                                                            {vis.s_free_pct && <th className={`p-1 border-r w-14 text-red-600 ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>L. %</th>}
                                                            {vis.k_pot && <th className={`p-1 border-r w-14 ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>Galim.</th>}
                                                            {vis.k_used && <th className={`p-1 border-r w-14 text-emerald-600 font-black ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>Išn.</th>}
                                                            {vis.k_used_pct && <th className={`p-1 border-r w-14 text-emerald-600 font-black ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>Išn. %</th>}
                                                            {vis.k_free_pct && <th className={`p-1 border-r w-14 text-red-600 font-black ${mIdx % 2 === 0 ? 'bg-gray-100/50' : 'bg-white'}`}>L. %</th>}
                                                        </Fragment>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr className="bg-gray-100/30 text-center"><td colSpan={1 + (report.months.length * monthColSpan.total)} className="p-1 px-4 font-black text-[9px] text-black uppercase border-b">MŪSŲ</td></tr>
                                                {ORDER_MUSU.map(c => renderRow(report.summary[c.toLowerCase()]))}
                                                {renderRow(report.visoMusu, "musu")}
                                                <tr className="bg-gray-100/30 text-center"><td colSpan={1 + (report.months.length * monthColSpan.total)} className="p-1 px-4 font-black text-[9px] text-black uppercase border-b border-t">SUBNUOMA</td></tr>
                                                {ORDER_SUBNUOMA.map(c => renderRow(report.summary[c.toLowerCase()]))}
                                                {renderRow(report.visoSubnuoma, "sub")}
                                                <tr className="bg-gray-800 text-white"><td colSpan={1 + (report.months.length * monthColSpan.total)} className="p-2 px-4 font-black text-[10px] uppercase tracking-widest text-center">GALUTINIAI REZULTATAI (v17.3)</td></tr>
                                                {renderRow(report.grandTotal, "grand")}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : activeTab === "uzsakymai" ? (
                                    <div className="overflow-x-auto max-h-[75vh]">
                                        <table className="w-full text-xs text-left border-collapse">
                                            <thead className="bg-gray-50 border-b font-black uppercase text-[10px] text-black tracking-widest sticky top-0 z-20 shadow-sm">
                                                <tr>
                                                    <th className="p-4 border-r w-10 no-print"></th>
                                                    <th className="p-4 border-r">Pardavimas</th>
                                                    <th className="p-4 border-r w-28 text-center">Nuo</th>
                                                    <th className="p-4 border-r w-28 text-center">Iki</th>
                                                    <th className="p-4 border-r w-20 text-center">Stendai</th>
                                                    <th className="p-4 w-24 text-center">Tipas</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {ordersReport.length > 0 ? ordersReport.map((order, i) => (
                                                    <Fragment key={i}>
                                                        <tr 
                                                            className={`border-b border-gray-100 hover:bg-indigo-50/50 cursor-pointer transition-colors ${expandedOrders.has(order.name) ? 'bg-indigo-50' : 'bg-white'}`}
                                                            onClick={() => toggleOrderExpansion(order.name)}
                                                        >
                                                            <td className="p-2 border-r text-center no-print"><IconChevron expanded={expandedOrders.has(order.name)} /></td>
                                                            <td className="p-2 border-r font-bold text-black text-[11px]">{order.name}</td>
                                                            <td className="p-2 border-r text-center font-mono text-black font-black italic text-[11px]">{order.startDate}</td>
                                                            <td className="p-2 border-r text-center font-mono text-black font-black italic text-[11px]">{order.endDate}</td>
                                                            <td className="p-2 border-r text-center font-black text-indigo-600 text-[11px]">{order.standsCount}</td>
                                                            <td className="p-2 text-center">
                                                                <span className={`px-2 py-0.5 rounded-full text-[9px] font-black uppercase border ${
                                                                    order.type === "mokamas" ? "bg-emerald-50 text-emerald-600 border-emerald-100" : order.type === "rezervacija" ? "bg-slate-100 text-black border-slate-300" : "bg-orange-50 text-orange-600 border-orange-100"
                                                                }`}>
                                                                    {order.type}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        {expandedOrders.has(order.name) && (
                                                            <tr className="no-print-row">
                                                                <td colSpan="6" className="bg-gray-50 p-3 border-b border-gray-300 shadow-inner">
                                                                    <div className="bg-white rounded-xl border border-gray-200 overflow-hidden max-w-3xl mx-auto shadow-sm">
                                                                        <div className="bg-gray-100 p-2 px-4 text-[10px] font-black uppercase text-black border-b">Stendai: {order.name}</div>
                                                                        <table className="w-full text-[11px] text-left border-collapse">
                                                                            <thead className="bg-white border-b text-black font-black uppercase text-[9px]">
                                                                                <tr><th className="p-2 px-4">Miestas</th><th className="p-2 px-4">Adresas</th><th className="p-2 px-4 w-28">Kodas</th></tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                {order.standsList.map((stand, sIdx) => (
                                                                                    <tr key={sIdx} className="border-b border-gray-50 hover:bg-indigo-50/30">
                                                                                        <td className="p-2 px-4 font-bold text-black">{stand.miestas}</td>
                                                                                        <td className="p-2 px-4 text-black font-bold">{stand.adresas}</td>
                                                                                        <td className="p-2 px-4 font-mono font-black text-indigo-600">{stand.kodas}</td>
                                                                                    </tr>
                                                                                ))}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        )}
                                                    </Fragment>
                                                )) : <tr><td colSpan="6" className="p-10 text-center text-black font-black italic">Nerasta užsakymų</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto max-h-[75vh]">
                                        <table className="w-full text-xs text-left border-collapse">
                                            <thead className="bg-gray-50 border-b font-black uppercase text-[10px] text-black tracking-widest sticky top-0 z-20 shadow-sm">
                                                <tr><th className="p-4 border-r">Būsena</th><th className="p-4 border-r">Kodas</th><th className="p-4 border-r">Miestas</th><th className="p-4 border-r min-w-[200px]">Adresas</th><th className="p-4 border-r">Kategorija</th></tr>
                                            </thead>
                                            <tbody>
                                                {standInventory.size > 0 ? Array.from(standInventory.values()).map((stand, i) => (
                                                    <tr key={i} className="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                                                        <td className="p-2 border-r whitespace-nowrap"><span className={`px-2 py-0.5 rounded-full text-[9px] font-black uppercase border ${stand.status === "Aktyvus" ? "bg-emerald-50 text-emerald-600 border-emerald-100" : stand.status === "Neaktyvus" ? "bg-rose-50 text-rose-600 border-rose-100" : "bg-amber-50 text-amber-600 border-amber-100"}`}>{stand.status}</span></td>
                                                        <td className="p-2 border-r font-mono font-black text-black">{stand.kodas}</td>
                                                        <td className="p-2 border-r text-black font-black">{stand.miestas}</td>
                                                        <td className="p-2 border-r text-black font-bold italic text-[11px] truncate max-w-[250px]">{stand.adresas}</td>
                                                        <td className="p-2 text-indigo-500 font-black uppercase text-[10px] tracking-tighter">{stand.kategorija}</td>
                                                    </tr>
                                                )) : <tr><td colSpan="5" className="p-10 text-center text-black font-black italic">Nėra duomenų</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        ) : (
                            !loading && (
                                <div className="bg-white rounded-3xl border-2 border-dashed border-gray-200 py-32 text-center shadow-inner animate-in fade-in">
                                    <div className="bg-indigo-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 text-indigo-300"><IconFile /></div>
                                    <h2 className="text-xl lg:text-2xl font-black text-indigo-900 mb-2 uppercase tracking-widest tracking-tight leading-none text-center">Statikos užimtumo ataskaitos</h2>
                                    <p className="text-black text-xs lg:text-sm max-w-xs mx-auto font-black leading-relaxed italic mt-2">Įkelkite „Eksportas_Statika.xlsx“ failą analizei.</p>
                                </div>
                            )
                        )}
                        {loading && (
                            <div className="flex flex-col items-center gap-4 py-32 animate-in fade-in">
                                <div className="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
                                <p className="text-indigo-900 font-black animate-pulse uppercase tracking-widest text-[10px]">Apdorojama...</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
